@model List<INSY7315_ElevateDigitalStudios_POE.Models.Client>

@{
    ViewBag.Title = "Clients";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link rel="stylesheet" href="~/css/clients.css" />

<div class="clients-page">
    <div class="clients-header">
        <h1>Clients</h1>
        <div class="search-container">
            <input type="text" id="clientSearch" class="search-input" placeholder="Search clients ...">
            <a class="search-icon">
                <img src="~/images/search.png" width="10" height="10">
            </a>
        </div>
    </div>
    
    <div class="clients-actions">
        <a href="@Url.Action("AddClients", "Clients")" class="btn add-btn"><i class="fas fa-plus-circle"></i> Add new</a>
        <button class="btn filter-btn" onclick="toggleFilterMenu()"><i class="fas fa-filter"></i> Filter</button>
    </div>

    <div class="clients-table">
        <table>
            <thead>
                <tr>
                    <th>Client Name</th>
                    <th>Mobile</th>
                    <th>Email</th>
                    <th>Company Name</th>
                    <th>Operation</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var client in Model)
                    {
                        <tr data-client-id="@client.id">
                            <td>@(client.name + " " + client.surname)</td>
                            <td>@client.phoneNumber</td>
                            <td>@client.email</td>
                            <td>@client.companyName</td>
                            <td>
                                <a href="#" class="edit-btn">
                                    <img src="~/images/delete.png" alt="Logo" width="35" height="35">
                                </a>

                                <a href="#" class="delete-btn" data-client-id="@client.id">
                                    <img src="~/images/delete.png" alt="Delete" width="35" height="35">
                                </a>

                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" style="text-align:center; color:#64748b; font-style:italic;">
                            No clients found.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>



<!-- Filter Popup Menu -->
<div id="filterMenu" class="filter-popup">
    <div class="filter-popup-content">
        <span class="filter-close" onclick="closeFilterMenu()">&times;</span>
        <h3 class="filter-heading">Filter Clients</h3>
        <ul class="filter-options">
            <li><a href="#" onclick="selectFilter('alphabetical')">Alphabetical A-Z</a></li>
            <li><a href="#" onclick="selectFilter('newest')">Date Added newest - oldest</a></li>
            <li><a href="#" onclick="selectFilter('oldest')">Date added oldest - newest</a></li>
            <li><a href="#" onclick="selectFilter('recent')">Recently added</a></li>
        </ul>
    </div>
</div>

<!-- Delete Confirmation Modal not programmed just a pop up -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h2>Delete Client</h2>
        <p>Are you sure you want to delete this client?</p>
        <div class="modal-actions">
            <button id="confirmDelete" class="btn confirm-btn" >Yes</button>
            <button class="btn cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        // Live search for quotations by client name
        const searchInput = document.getElementById('clientSearch');
        searchInput.addEventListener('input', function () {
            const query = this.value.toLowerCase().trim();
            const rows = document.querySelectorAll('.clients-table tbody tr');

            rows.forEach(row => {
                const clientName = row.querySelector('td:first-child').textContent.toLowerCase();
                if (clientName.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        /* ---------------- FILTER MENU ---------------- */
        // --- Filter Popup Controls ---
        window.toggleFilterMenu = function () {
            const filterMenu = document.getElementById("filterMenu");
            filterMenu.style.display = filterMenu.style.display === "block" ? "none" : "block";
        };

        // Close filter popup when clicking outside
        window.addEventListener("click", function (event) {
            const filterMenu = document.getElementById("filterMenu");
            const filterBtn = document.querySelector(".filter-btn");
            if (event.target !== filterMenu && !filterMenu.contains(event.target) && event.target !== filterBtn) {
                filterMenu.style.display = "none";
            }
        });

        // --- Filtering Logic ---
        window.selectFilter = function (filterType) {
            const rows = Array.from(document.querySelectorAll("tbody tr[data-client-id]"));
            const tbody = document.querySelector("tbody");

            // Remove any existing "No clients found" message
            const noClientsRow = tbody.querySelector("td[colspan='5']");
            if (noClientsRow) noClientsRow.parentElement.remove();

            // Reset order before filtering (optional)
            rows.sort((a, b) => 0);

            if (filterType === "alphabetical") {
                rows.sort((a, b) => {
                    const nameA = a.children[0].innerText.toLowerCase();
                    const nameB = b.children[0].innerText.toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            }

            else if (filterType === "newest") {
                // Assuming rows are already rendered newest -> oldest by default
                // Reverse if not
                rows.reverse();
            }

            else if (filterType === "oldest") {
                // Oldest -> newest (default order)
                // You can keep as-is, but we’ll reset to default render order
            }

            else if (filterType === "recent") {
                // Example: show last 3 added clients only
                rows.sort((a, b) => b.rowIndex - a.rowIndex);
                const recentRows = rows.slice(0, 3);
                rows.length = 0;
                rows.push(...recentRows);
            }

            // Clear and repopulate table
            tbody.innerHTML = "";
            rows.forEach(r => tbody.appendChild(r));

            // Close popup after filter is applied
            document.getElementById("filterMenu").style.display = "none";
        }

        window.toggleFilterMenu = function () {
            const filterMenu = document.getElementById("filterMenu");
            filterMenu.classList.toggle("show");
        };

        window.closeFilterMenu = function () {
            document.getElementById("filterMenu").classList.remove("show");
        };

        // Close popup when clicking outside content
        window.addEventListener("click", (event) => {
            const filterMenu = document.getElementById("filterMenu");
            const content = filterMenu.querySelector(".filter-popup-content");
            if (event.target === filterMenu && !content.contains(event.target)) {
                filterMenu.classList.remove("show");
            }
        });

        /* ---------------- DELETE CONFIRMATION MODAL ---------------- */

        const deleteButtons = document.querySelectorAll(".delete-btn");
        const deleteModal = document.getElementById("deleteModal");
        const confirmDeleteBtn = document.getElementById("confirmDelete");
        const cancelBtn = deleteModal.querySelector(".cancel-btn");

        let clientToDeleteId = null;

        // Open modal when delete button is clicked
        deleteButtons.forEach(btn => {
            btn.addEventListener("click", (event) => {
                event.preventDefault();
                clientToDeleteId = btn.dataset.clientId;
                deleteModal.classList.add("show"); // use the .show class instead of display:block
            });
        });

        // Confirm deletion
        confirmDeleteBtn.addEventListener("click", async () => {
            if (!clientToDeleteId) return;

            try {
                const response = await fetch('/Clients/DeleteClient', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(clientToDeleteId)
                });

                const data = await response.json();
                if (data.success) {
                    // Remove row from table
                    const row = document.querySelector(`tr[data-client-id='${clientToDeleteId}']`);
                    if (row) row.remove();

                    alert("Client deleted successfully!");
                } else {
                    alert("Failed to delete client.");
                }
            } catch (error) {
                console.error("Error deleting client:", error);
                alert("An error occurred.");
            }

            // Close modal
            deleteModal.classList.remove("show");
            clientToDeleteId = null;
        });

        // Cancel deletion
        cancelBtn.addEventListener("click", () => {
            deleteModal.classList.remove("show");
            clientToDeleteId = null;
        });

        // Close modal when clicking outside
        window.addEventListener("click", (event) => {
            if (event.target === deleteModal) {
                deleteModal.classList.remove("show");
                clientToDeleteId = null;
            }
        });
});
</script>