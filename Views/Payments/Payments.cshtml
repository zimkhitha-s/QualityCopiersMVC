@model List<INSY7315_ElevateDigitalStudios_POE.Models.Invoice>

@{
    ViewBag.Title = "Payments";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/quotations-styles.css" asp-append-version="true" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/agrandir" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <div class="content-header">
                <h1 class="page-title">Payments</h1>
                <div class="header-actions">
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Search payments ...">
                        <a class="search-icon"><img src="~/images/search.png" width="10" height="10"></a>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showFilterModal()">
                    <a class="btn-icon"><img src="~/images/filter-btn.png" width="20" height="20"></a>
                    Filter
                </button>
                <button class="btn btn-success" onclick="downloadPaymentsReport(3)">Last 3 Months</button>
                <button class="btn btn-success" onclick="downloadPaymentsReport(6)">Last 6 Months</button>
                <button class="btn btn-success" onclick="downloadPaymentsReport(12)">Last 12 Months</button>
            </div>

            <div class="table-container">
                @Html.AntiForgeryToken()
                <table id="paymentsTable" class="quotations-table">
                    <thead>
                        <tr>
                            <th>Client Name</th>
                            <th>Invoice Number</th>
                            <th>Status</th>
                            <th>Operation</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var invoice in Model)
                            {
                                <tr data-invoice-id="@invoice.Id">
                                    <td>@invoice.ClientName</td>
                                    <td>#@invoice.InvoiceNumber</td>
                                    <td id="invoice-status-@invoice.Id">@invoice.Status</td>
                                    <td>
                                        <div class="td-actions">
                                            <a href="#" class="save-btn-payments text-success" data-invoice-id="@invoice.Id" title="Download Payment">
                                                <img src="~/images/save_icon.png" alt="Save" class="operation-icons">
                                            </a>
                                            <a href="#" class="send-btn-payments text-success" data-invoice-id="@invoice.Id" title="Send Payment">
                                                <img src="~/images/send_icon.png" alt="Send" class="operation-icons">
                                            </a>
                                            <a href="#" class="delete-btn-payments" data-invoice-id="@invoice.Id" title="Delete Payment">
                                                <img src="~/images/delete_icon.png" alt="Delete" class="operation-icons">
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" style="text-align:center; padding:20px; font-weight:500; color:#999;">
                                    No Payments Yet.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="modal-overlay" onclick="hideFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Filter Payments</h3>
                <button class="close-btn" onclick="hideFilterModal()">×</button>
            </div>
            <div class="filter-options">
                <div class="filter-option" onclick="applyFilter('alphabetical')">Alphabetical - A–Z</div>
                <div class="filter-option" onclick="applyFilter('date-newest')">Newest to Oldest</div>
                <div class="filter-option" onclick="applyFilter('date-oldest')">Oldest to Newest</div>
                <div class="filter-option clear-filter" onclick="clearFilters()">Clear Filters</div>
            </div>
        </div>
    </div>

    <!-- Save Confirmation Modal -->
    <div id="saveModal" class="modal-overlay" style="display:none;">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="hideSaveModal()">&times;</button>
            <div class="modal-header"><h3 class="modal-title">Save Payment</h3></div>
            <p class="modal-message">Would you like to download this payment as a PDF?</p>
            <div class="modal-actions">
                <button class="btn btn-success" id="confirmSaveBtn">Yes, Download</button>
                <button class="btn btn-secondary" onclick="hideSaveModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Send Confirmation Modal -->
    <div id="shareModal" class="modal-overlay" style="display:none;">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="hideShareModal()">&times;</button>
            <div class="modal-header"><h3 class="modal-title">Send Payment</h3></div>
            <p class="modal-message">Are you sure you want to send this payment to the client?</p>
            <div class="modal-actions">
                <button class="btn btn-success" id="confirmShareBtn">Yes, Send</button>
                <button class="btn btn-secondary" onclick="hideShareModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay" style="display:none;">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="hideDeleteModal()">&times;</button>
            <div class="modal-header"><h3 class="modal-title">Delete Payment</h3></div>
            <p class="modal-message">Are you sure you want to delete this payment?</p>
            <div class="modal-actions">
                <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
                <button class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let selectedPaymentId = null;

        const tableBody = document.querySelector('.quotations-table tbody');
        const originalRows = Array.from(tableBody.querySelectorAll('tr')).map(r => r.cloneNode(true));
        const searchInput = document.querySelector('.search-input');
        let currentFilter = null;

        function showFilterModal() { document.getElementById('filterModal').style.display = 'flex'; }
        function hideFilterModal() { document.getElementById('filterModal').style.display = 'none'; }

        window.applyFilter = function (filterType) {
            currentFilter = filterType;
            applySearchAndFilter(searchInput?.value.trim().toLowerCase() || '');
            hideFilterModal();
        };

        window.clearFilters = function () {
            currentFilter = null;
            applySearchAndFilter('');
            hideFilterModal();
        };

        function applySearchAndFilter(searchQuery) {
            let rows = originalRows.map(r => r.cloneNode(true))
                .filter(r => !r.querySelector('td[colspan]'));

            if (currentFilter) {
                switch (currentFilter) {
                    case 'alphabetical':
                        rows.sort((a, b) => {
                            const aName = a.querySelector('td:nth-child(1)').textContent.trim().toLowerCase();
                            const bName = b.querySelector('td:nth-child(1)').textContent.trim().toLowerCase();
                            return aName.localeCompare(bName);
                        });
                        break;
                    case 'date-newest':
                    case 'recent':
                        rows.sort((a, b) => new Date(b.dataset.createdAt) - new Date(a.dataset.createdAt));
                        break;
                    case 'date-oldest':
                        rows.sort((a, b) => new Date(a.dataset.createdAt) - new Date(b.dataset.createdAt));
                        break;
                }
            }

            if (searchQuery) {
                rows = rows.filter(row => {
                    const clientName = (row.querySelector('td:nth-child(1)')?.textContent || '').toLowerCase();
                    const invoiceNumber = (row.querySelector('td:nth-child(2)')?.textContent || '').toLowerCase();
                    const status = (row.querySelector('td:nth-child(3)')?.textContent || '').toLowerCase();

                    return (
                        clientName.includes(searchQuery) ||
                        invoiceNumber.includes(searchQuery) ||
                        status.includes(searchQuery)
                    );
                });
            }

            tableBody.innerHTML = '';
            if (rows.length) {
                rows.forEach(r => tableBody.appendChild(r));
            } else {
                const colspan = 6;
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `
                    <td colspan="${colspan}" style="text-align:center; padding:20px; font-weight:500; color:#999;">
                        No matching payments found.
                    </td>`;
                tableBody.appendChild(noDataRow);
            }
        }

        searchInput?.addEventListener('input', function () {
            applySearchAndFilter(this.value.trim().toLowerCase());
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') hideFilterModal();
        });

        function showSaveModal(id) { selectedPaymentId = id; document.getElementById('saveModal').style.display = 'flex'; }
        function hideSaveModal() { document.getElementById('saveModal').style.display = 'none'; }

        function showShareModal(id) { selectedPaymentId = id; document.getElementById('shareModal').style.display = 'flex'; }
        function hideShareModal() { document.getElementById('shareModal').style.display = 'none'; }

        function showDeleteModal(id) { selectedPaymentId = id; document.getElementById('deleteModal').style.display = 'flex'; }
        function hideDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }

        document.addEventListener("DOMContentLoaded", () => {
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || "";

        document.querySelectorAll('.save-btn-payments').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                showSaveModal(btn.dataset.invoiceId);
            });
        });

        document.querySelectorAll('.send-btn-payments').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                showShareModal(btn.dataset.invoiceId);
            });
        });

        document.querySelectorAll('.delete-btn-payments').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                showDeleteModal(btn.dataset.invoiceId);
            });
        });

        document.getElementById('confirmSaveBtn').addEventListener('click', async () => {
            if (!selectedPaymentId) return;
            hideSaveModal();
            const res = await fetch('@Url.Action("SaveInvoice", "Invoices")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                body: JSON.stringify({ invoiceId: selectedPaymentId })
            });

            if (res.ok) {
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Payment_${selectedPaymentId}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert("Failed to download payment PDF.");
            }
            selectedPaymentId = null;
        });

        document.getElementById('confirmShareBtn').addEventListener('click', async () => {
            if (!selectedPaymentId) return;
            hideShareModal();

            const res = await fetch('@Url.Action("SendInvoice", "Invoices")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                body: JSON.stringify({ invoiceId: selectedPaymentId })
            });

            const result = await res.json();
            if (result.success) alert("Payment sent successfully!");
            else alert("Failed to send payment.");
            selectedPaymentId = null;
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!selectedPaymentId) return;
            hideDeleteModal();

            const res = await fetch('@Url.Action("DeleteInvoice", "Invoices")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                body: JSON.stringify({ invoiceId: selectedPaymentId })
            });

            const result = await res.json();
            if (result.success) {
                document.querySelector(`tr[data-invoice-id="${selectedPaymentId}"]`)?.remove();
                alert("Payment deleted successfully.");
            } else {
                alert("Failed to delete payment.");
            }
            selectedPaymentId = null;
        });
    });

    async function downloadPaymentsReport(months) {
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || "";
        const res = await fetch('/Payments/DownloadPaymentsReport', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
            body: JSON.stringify({ months })
        });

        if (!res.ok) return alert("Failed to generate report.");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Payments_Report_${months}Months.pdf`;
        a.click();
        URL.revokeObjectURL(url);
    }
    </script>
</body>
</html>
