@model List<INSY7315_ElevateDigitalStudios_POE.Models.Quotation>

@{
    ViewBag.Title = "Quotations";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/quotations-styles.css" asp-append-version="true" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/agrandir" rel="stylesheet">
</head>
<body>
    <div class="app-container">

        <!-- Main Content Section -->
        <main class="main-content">

            <!-- Heading and Search Bar Section -->
            <div class="content-header">
                <h1 class="page-title">Quotations</h1>
                <div class="header-actions">
                    <div class="search-container">
                        <input type="text" id="quotationSearch" class="search-input" placeholder="Search quotations ...">
                        <a class="search-icon">
                            <img src="~/images/search.png" width="10" height="10">
                        </a>
                    </div>
                </div>
            </div>

            <!-- Create and Filter Quotations Section -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="location.href='/Quotations/CreateQuotation'">
                    <a class="btn-icon">
                        <img src="~/images/create-btn.png" width="20" height="20">
                    </a>
                    Create
                </button>
                <button class="btn btn-secondary" onclick="showFilterModal()">
                    <a class="btn-icon">
                        <img src="~/images/filter-btn.png" width="20" height="20">
                    </a>
                    Filter
                </button>
            </div>

            <!-- Display Quotations Section -->
            <div class="table-container">
                <table class="quotations-table">
                    <thead>
                        <tr>
                            <th>Client Name</th>
                            <th>Email</th>
                            <th>Date of Quote</th>
                            <th>Quote number</th>
                            <th>Status</th>
                            <th>Operation</th>
                        </tr>
                    </thead>
                    <tbody id="quotationTableBody">
                        @if (Model != null && Model.Any())
                        {
                            foreach (var quotation in Model)
                            {
                                <tr>
                                    <td>@quotation.clientName</td>
                                    <td>@quotation.email</td>
                                    <td>@quotation.createdAt.ToDateTime().ToString("yyyy/MM/dd")</td>
                                    <td>@quotation.quoteNumber</td>
                                    <td>
                                        <select class="status-dropdown" data-quote-id="@quotation.id">
                                            <option value="In Progress" selected="@(quotation.status == "In Progress" ? "selected" : null)">In Progress</option>
                                            <option value="Accepted" selected="@(quotation.status == "Accepted" ? "selected" : null)">Accepted</option>
                                            <option value="Declined" selected="@(quotation.status == "Declined" ? "selected" : null)">Declined</option>
                                        </select>

                                    </td>

                                    <td>
                                        <a href="#" data-quote-id="@quotation.id" class="delete-btn">
                                            <img src="~/images/delete.png" alt="Logo" width="35" height="35">
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" style="text-align:center; padding:20px; font-weight:500; color:#999;">
                                    @ViewBag.Message
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Added filter Modal Popup -->
    <div id="filterModal" class="modal-overlay" onclick="hideFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Filter Quotations</h3>
                <button class="close-btn" onclick="hideFilterModal()">×</button>
            </div>
            <div class="filter-options">
                <div class="filter-option" onclick="applyFilter('alphabetical')">Alphabetical - A-Z</div>
                <div class="filter-option" onclick="applyFilter('date-newest')">Date Added - Newest to Oldest</div>
                <div class="filter-option" onclick="applyFilter('date-oldest')">Date Added - Oldest to Newest</div>
                <div class="filter-option" onclick="applyFilter('recent')">Recently added</div>
                <div class="filter-option" onclick="applyFilter('progress')">In Progress</div>
                <div class="filter-option" onclick="applyFilter('accepted')">Accepted</div>
                <div class="filter-option" onclick="applyFilter('declined')">Declined</div>
                <div class="filter-option clear-filter" onclick="clearFilters()">Clear Filters</div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay" style="display: none;">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="hideDeleteModal()">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title">Delete Quotation</h3>
            </div>
            <p class="modal-message">Are you sure you want to delete this quotation?</p>
            <div class="modal-actions">
                <button class="btn-confirm" id="confirmDeleteBtn">Yes</button>
                <button class="btn-cancel" onclick="hideDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>


    <script>

        /*----------------------------------------------SEARCH QUOTATIONS FUNCTIONALITY-----------------------------------------------------*/

        // live search for quotations by client name - it uses the browser
        const searchInput = document.getElementById('quotationSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const query = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('.quotations-table tbody tr');

                rows.forEach(row => {
                    const clientName = row.querySelector('td:first-child').textContent.toLowerCase();
                    row.style.display = clientName.includes(query) ? '' : 'none';
                });
            });
        }

        /*----------------------------------------------FILTER QUOTATIONS FUNCTIONALITY-----------------------------------------------------*/

        // showing and hiding filter modal
        function showFilterModal() {
            document.getElementById("filterModal").style.display = "flex";
        }

        function hideFilterModal() {
            document.getElementById("filterModal").style.display = "none";
        }

        // applying the filter - save all original rows to reset later
        const originalRows = Array.from(document.querySelectorAll("#quotationTableBody tr"));

        function applyFilter(filterType) {
            const tableBody = document.getElementById("quotationTableBody");

            // always start from the original unfiltered rows
            let rows = Array.from(originalRows);

            // close modal after choosing filter
            hideFilterModal();

            rows = rows.filter(r => !r.querySelector("td[colspan]"));

            // filtering by A-Z, old - new, new - old, status
            switch (filterType) {
                case "alphabetical":
                    rows.sort((a, b) => {
                        const nameA = a.children[0].textContent.trim().toLowerCase();
                        const nameB = b.children[0].textContent.trim().toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                    break;

                case "date-newest":
                    rows.sort((a, b) => {
                        const dateA = new Date(a.children[2].textContent.trim());
                        const dateB = new Date(b.children[2].textContent.trim());
                        return dateB - dateA;
                    });
                    break;

                case "date-oldest":
                    rows.sort((a, b) => {
                        const dateA = new Date(a.children[2].textContent.trim());
                        const dateB = new Date(b.children[2].textContent.trim());
                        return dateA - dateB;
                    });
                    break;

                case "recent":
                    rows.sort((a, b) => {
                        const dateA = new Date(a.children[2].textContent.trim());
                        const dateB = new Date(b.children[2].textContent.trim());
                        return dateB - dateA;
                    });
                    break;

                case "progress":
                case "accepted":
                case "declined":
                    rows = rows.filter(row => {
                        const status = row.querySelector(".status-dropdown").value.toLowerCase();
                        return status === filterType;
                    });
                    break;
            }

            tableBody.innerHTML = "";
            rows.forEach(row => tableBody.appendChild(row));
        }

        // clear filters
        function clearFilters() {
            const tableBody = document.getElementById("quotationTableBody");
            tableBody.innerHTML = "";
            originalRows.forEach(row => tableBody.appendChild(row));
            hideFilterModal();
        }

        // close modal with escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') hideFilterModal();
        });

        /*----------------------------------------------QUOTATION STATUS UPDATE FUNCTIONALITY-----------------------------------------------------*/

        // status dropdown update
        document.querySelectorAll('.status-dropdown').forEach(dropdown => {
            dropdown.addEventListener('change', async function () {
                const newStatus = this.value;
                const quoteId = this.dataset.quoteId;

                try {
                    const response = await fetch('/Quotations/UpdateQuotationStatus', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: quoteId, status: newStatus })
                    });

                    if (!response.ok) throw new Error('Failed to update status');
                    console.log('Quotation status updated successfully');
                } catch (err) {
                    console.error(err);
                    alert('Error updating quotation status. Please try again.');
                }
            });
        });

        /*----------------------------------------------DELETE QUOTATION FUNCTIONALITY-----------------------------------------------------*/

        let quoteToDelete = null;

        // open modal when delete icon is clicked
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                quoteToDelete = btn.dataset.quoteId;
                showDeleteModal();
            });
        });

        function showDeleteModal() {
            document.getElementById("deleteModal").style.display = "flex";
        }

        function hideDeleteModal() {
            document.getElementById("deleteModal").style.display = "none";
            quoteToDelete = null;
        }

        // deletion confirmation
        document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
            if (!quoteToDelete) return;

            try {
                const response = await fetch("/Quotations/DeleteQuotation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ quotationId: quoteToDelete })
                });

                const data = await response.json();

                if (data.success) {
                    const row = document.querySelector(`[data-quote-id="${quoteToDelete}"]`).closest("tr");
                    if (row) row.remove();

                    alert("Quotation deleted successfully.");
                } else {
                    alert("Failed to delete quotation.");
                }
            } catch (err) {
                console.error("Error deleting quotation:", err);
                alert("An error occurred while deleting quotation.");
            } finally {
                hideDeleteModal();
            }
        });
    </script>
</body>
</html>
<!------------------------------------------------------------------------------------------End Of File------------------------------------------------------------------------------>  