@model List<INSY7315_ElevateDigitalStudios_POE.Models.Quotation>

@{
    ViewBag.Title = "Quotations";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="~/css/quotations-styles.css" asp-append-version="true" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<div class="app-container">
    <main class="main-content">
        <div class="content-header">
            <h1 class="page-title-quotations">Quotations</h1>

            <div class="header-actions">
                <div class="search-container">
                    <input type="text" id="quotationSearch" class="search-input" placeholder="Search quotations ...">
                    <span class="search-icon">
                        <img src="@Url.Content("~/images/search.png")" width="14" height="14" alt="Search">
                    </span>
                </div>
            </div>
        </div>

        <div class="action-buttons mb-3">
            <button class="btn btn-primary" type="button" onclick="location.href='@Url.Action("CreateQuotation","Quotations")'">
                <img src="@Url.Content("~/images/create-btn.png")" width="20" height="20" class="mr-1" alt="Create"> Create
            </button>

            <button class="btn btn-secondary" type="button" onclick="showFilterModal()">
                <img src="@Url.Content("~/images/filter-btn.png")" width="20" height="20" class="mr-1" alt="Filter"> Filter
            </button>
        </div>

        <div class="table-container">

            @Html.AntiForgeryToken()

            <table class="quotations-table table table-borderless">
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Email</th>
                        <th>Date of Quote</th>
                        <th>Quote number</th>
                        <th>Status</th>
                        <th>Operation</th>
                    </tr>
                </thead>
                <tbody id="quotationTableBody">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var quotation in Model)
                        {
                            var isoCreatedAt = quotation.createdAt != null ? quotation.createdAt.ToDateTime().ToString("o") : string.Empty;
                            <tr data-quote-id="@quotation.id" data-created-at="@isoCreatedAt">
                                <td class="client-name">@quotation.clientName</td>
                                <td class="client-email">@quotation.email</td>
                                <td class="created-at">@(quotation.createdAt != null ? quotation.createdAt.ToDateTime().ToString("yyyy/MM/dd") : "-")</td>
                                <td class="quote-number">@quotation.quoteNumber</td>
                                <td class="status-text">@quotation.status</td>

                                <td>
                                    <div class="td-quote-actions">
                                        <a href="#" class="download-btn-quotation" data-quotation-id="@quotation.id" title="Download Quotation">
                                            <img src="~/images/save_icon.png" alt="Download" class="operation-icons-quotes">
                                        </a>
                                        <a href="#" class="delete-btn-quotations" data-quote-id="@quotation.id" title="Delete Quotation">
                                            <img src="~/images/delete_icon.png" alt="Delete" class="operation-icons-quotes">
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" style="text-align:center; padding:20px; font-weight:500; color:#999;">
                                "No Quotations Yet."
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </main>
</div>

<!-- Filter modal -->
<div id="filterModal" class="modal-overlay" onclick="hideFilterModal()">
    <div class="filter-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Filter Quotations</h3>
            <button class="close-btn" onclick="hideFilterModal()">×</button>
        </div>
        <div class="filter-options">
            <div class="filter-option" onclick="applyFilter('alphabetical')">Alphabetical - A-Z</div>
            <div class="filter-option" onclick="applyFilter('date-newest')">Date Added - Newest to Oldest</div>
            <div class="filter-option" onclick="applyFilter('date-oldest')">Date Added - Oldest to Newest</div>
            <div class="filter-option" onclick="applyFilter('recent')">Recently added</div>
            <div class="filter-option" onclick="applyFilter('pending')">Pending</div>
            <div class="filter-option" onclick="applyFilter('accepted')">Accepted</div>
            <div class="filter-option" onclick="applyFilter('declined')">Declined</div>
            <div class="filter-option clear-filter" onclick="clearFilters()">Clear Filters</div>
        </div>
    </div>
</div>

<!-- Download Quotation Modal -->
<div id="quotationDownloadModal" class="modal-overlay" style="display:none;">
    <div class="delete-modal" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="hideQuotationDownloadModal()">&times;</button>
        <div class="modal-header">
            <h3 class="modal-title">Download Quotation</h3>
        </div>
        <p class="modal-message">Would you like to download this quotation as a PDF?</p>
        <div class="modal-actions">
            <button class="btn btn-success" id="confirmDownloadQuotationBtn">Yes, Download</button>
            <button class="btn btn-secondary" onclick="hideQuotationDownloadModal()">Cancel</button>
        </div>
    </div>
</div>


<!-- Delete confirmation modal -->
<div id="deleteModal" class="modal-overlay" style="display:none;">
    <div class="delete-modal" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="hideDeleteModal()">&times;</button>
        <div class="modal-header"><h3 class="modal-title">Delete Quotation</h3></div>
        <p class="modal-message">Are you sure you want to delete this quotation?</p>
        <div class="modal-actions">
            <button class="btn btn-danger" id="confirmDeleteBtn">Yes</button>
            <button class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    (function () {
        const antiForgeryInput = document.querySelector('input[name="__RequestVerificationToken"]');
        const antiForgeryToken = antiForgeryInput ? antiForgeryInput.value : null;

        async function safePost(url, payload) {
            const headers = { 'Content-Type': 'application/json' };
            if (antiForgeryToken) headers['RequestVerificationToken'] = antiForgeryToken;
            const resp = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });
            return resp;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('quotationTableBody');
            if (!tableBody) return console.warn('quotationTableBody not found.');

            const originalRows = Array.from(tableBody.querySelectorAll('tr')).map(r => r.cloneNode(true));

            // SEARCH functionality
            const searchInput = document.getElementById('quotationSearch');
            searchInput?.addEventListener('input', function () {
                const q = this.value.toLowerCase().trim();
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    if (row.querySelector('td[colspan]')) return;
                    const clientName = (row.querySelector('.client-name')?.textContent || '').toLowerCase();
                    row.style.display = clientName.includes(q) ? '' : 'none';
                });
            });

            window.applyFilter = function (filterType) {
                let rows = originalRows.map(r => r.cloneNode(true)).filter(r => !r.querySelector('td[colspan]'));

                switch (filterType) {
                    case 'alphabetical':
                        rows.sort((a, b) => a.querySelector('.client-name').textContent.trim().localeCompare(b.querySelector('.client-name').textContent.trim()));
                        break;
                    case 'date-newest':
                    case 'recent':
                        rows.sort((a, b) => new Date(b.dataset.createdAt) - new Date(a.dataset.createdAt));
                        break;
                    case 'date-oldest':
                        rows.sort((a, b) => new Date(a.dataset.createdAt) - new Date(b.dataset.createdAt));
                        break;
                    case 'pending':
                    case 'accepted':
                    case 'declined':
                        rows = rows.filter(r => (r.querySelector('.status-dropdown').value || '').toLowerCase() === filterType);
                        break;
                }

                tableBody.innerHTML = '';
                rows.forEach(r => tableBody.appendChild(r));
                hideFilterModal();
            };

            window.clearFilters = function () {
                tableBody.innerHTML = '';
                originalRows.forEach(r => tableBody.appendChild(r.cloneNode(true)));
                hideFilterModal();
            };

            let selectedQuotationIdForDownload = null;
            const downloadModal = document.getElementById('quotationDownloadModal');
            const confirmDownloadBtn = document.getElementById('confirmDownloadQuotationBtn');

            tableBody.addEventListener('click', function (e) {
                const anchor = e.target.closest('a.download-btn-quotation');
                if (!anchor) return; 
                e.preventDefault();

                const qid = anchor.dataset.quotationId || anchor.getAttribute('data-quotation-id');
                if (!qid) {
                    alert('Invalid quotation ID.');
                    return;
                }
                selectedQuotationIdForDownload = qid;
                if (downloadModal) downloadModal.style.display = 'flex';
            });

            // hide modal function
            window.hideQuotationDownloadModal = function () {
                if (downloadModal) downloadModal.style.display = 'none';
                selectedQuotationIdForDownload = null;
                if (confirmDownloadBtn) {
                    confirmDownloadBtn.disabled = false;
                    confirmDownloadBtn.textContent = 'Yes, Download';
                }
            };

            if (downloadModal) {
                downloadModal.addEventListener('click', function () {
                    hideQuotationDownloadModal();
                });
            }

            // confirm download action
            if (confirmDownloadBtn) {
                confirmDownloadBtn.addEventListener('click', async function () {
                    if (!selectedQuotationIdForDownload) return alert('Invalid quotation ID.');

                    const btn = this;
                    btn.disabled = true;
                    btn.textContent = 'Downloading...';

                    try {
                        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                        const token = tokenInput ? tokenInput.value : '';

                        const payload = { QuotationId: selectedQuotationIdForDownload };
                        const response = await fetch('/Quotations/DownloadQuotation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': token
                            },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            console.error('Download error response:', errText);
                            alert('Failed to download quotation.');
                            return;
                        }

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;

                        const disposition = response.headers.get('Content-Disposition');
                        let fileName = `Quotation_${selectedQuotationIdForDownload}.pdf`;
                        if (disposition && disposition.includes('filename=')) {
                            fileName = disposition.split('filename=')[1].replace(/"/g, '').trim();
                        }

                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                        hideQuotationDownloadModal();
                    } catch (err) {
                        console.error('Error downloading quotation:', err);
                        alert('An error occurred while downloading the quotation.');
                    } finally {
                        selectedQuotationIdForDownload = null;
                        btn.disabled = false;
                        btn.textContent = 'Yes, Download';
                    }
                });
            }

            // --- DELETE modal logic ---
            let quoteToDelete = null;
            const deleteModal = document.getElementById('deleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            tableBody.addEventListener('click', function (e) {
                const anchor = e.target.closest('a.delete-btn-quotations');
                if (!anchor) return;
                e.preventDefault();

                const qid = anchor.dataset.quoteId || anchor.getAttribute('data-quote-id');
                if (!qid) return alert('Invalid quotation id for delete.');

                quoteToDelete = qid;
                if (deleteModal) deleteModal.style.display = 'flex';
            });

            // hide delete modal
            window.hideDeleteModal = function () {
                if (deleteModal) deleteModal.style.display = 'none';
                quoteToDelete = null;
            };

            if (deleteModal) {
                deleteModal.addEventListener('click', function () {
                    hideDeleteModal();
                });
            }

            // confirm delete
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', async function () {
                    if (!quoteToDelete) return;
                    try {
                        const resp = await safePost('@Url.Action("DeleteQuotation", "Quotations")', { quotationId: quoteToDelete });
                        let data = null;
                        try { data = await resp.json(); } catch (err) { console.warn('Delete: no json response'); }

                        if (resp.ok && data && data.success) {
                            const row = tableBody.querySelector(`tr[data-quote-id="${quoteToDelete}"]`);
                            if (row) row.remove();
                            alert('Quotation deleted successfully.');
                        } else {
                            alert('Failed to delete quotation.');
                        }
                    } catch (err) {
                        console.error('Error deleting quotation:', err);
                        alert('Error deleting quotation.');
                    } finally {
                        hideDeleteModal();
                        quoteToDelete = null;
                    }
                });
            }

            // keyboard shortcuts
            document.addEventListener('keydown', function (ev) {
                if (ev.key === 'Escape') {
                    hideFilterModal();
                    hideQuotationDownloadModal();
                    hideDeleteModal();
                }
            });
        });

        window.showFilterModal = function () { document.getElementById('filterModal').style.display = 'flex'; };
        window.hideFilterModal = function () { document.getElementById('filterModal').style.display = 'none'; };

    })();
</script>


<!------------------------------------------------------------------------------------------End Of File------------------------------------------------------------------------------>  